# 依存関係の健全な更新 (dependency-health-update)

セキュリティ脆弱性や問題のあるライブラリを、依存関係チェーンを理解した上で、最も健全な方法で更新する

## 使用タイミング

- セキュリティアラートで特定のライブラリの更新が必要な場合
- テスト失敗の原因が古いライブラリバージョンにある場合
- 特定のライブラリを更新したいが、依存関係が複雑な場合

## 実行手順

### 1. 問題の特定

- 問題のあるライブラリとバージョンを特定する
- セキュリティアラートやテスト失敗から問題を把握する

### 2. 依存関係の調査

```bash
yarn why <問題のライブラリ>
```

- なぜそのバージョンが使われているかを調査する
- 依存関係チェーンを把握する（直接依存 vs 間接依存）
- 依存元のライブラリをメモする

### 3. 解決策の試行（優先度順に実施）

#### 優先度1: 直接的な更新

```bash
yarn up <ライブラリ名>
yarn why <ライブラリ名>  # 結果を検証
```

- 問題のライブラリのバージョンが上がるか確認
- 上がった場合は検証フェーズへ
- 上がらない場合は優先度2へ

#### 優先度2: 上位ライブラリの更新

```bash
yarn why <問題のライブラリ>  # 依存元を特定
yarn up <上位ライブラリ名>
yarn why <問題のライブラリ>  # 再確認
```

- 上がらない場合、依存元（上位のライブラリ）を更新する
- 再度`yarn why`で問題のライブラリのバージョンを確認
- 必要に応じてさらに上位のライブラリも更新
- 上がった場合は検証フェーズへ
- 上がらない場合は優先度3へ

#### 優先度3: 中間依存関係の追加

```bash
yarn add -D <中間ライブラリ>@latest
yarn why <問題のライブラリ>  # 再確認
```

- 上位ライブラリの更新でも解決しない場合
- 中間の依存関係をdevDependenciesに追加して最新版を強制
- 例: fsevents → node-gyp → cacache のケース
- 上がった場合は検証フェーズへ
- 上がらない場合は優先度4へ

#### 優先度4: resolutions（最終手段）

```json
"resolutions": {
  "<問題のライブラリ>": "^安全なバージョン"
}
```

- 他の方法で解決できない場合のみ使用
- package.jsonにコメントで理由と削除予定を記載
- 定期的に削除を試みる

### 4. 検証

以下のコマンドを順番に実行し、すべて成功することを確認する：

```bash
# バージョンの確認
yarn why <問題のライブラリ>

# 型チェック
yarn typeCheck

# リンティング
yarn lint

# ビルド
yarn build

# テスト
yarn test
```

**検証の順序**
1. `yarn why` - バージョンが期待通りか確認
2. `yarn typeCheck` - 型エラーがないか（高速）
3. `yarn lint` - コードスタイルの問題がないか（高速）
4. `yarn build` - 本番ビルドが成功するか（重要）
5. `yarn test` - すべてのテストが通るか（最も時間がかかる）

**失敗時の対応**
- どの段階で失敗したかを記録
- 失敗した場合は変更を戻すか、別のアプローチを試す
- エラーメッセージから原因を特定

### 5. 後処理

**resolutionsを使った場合**
- package.jsonにコメントで経緯を記録
- 定期的に優先度1〜3の方法で削除を試みる

**中間依存関係を追加した場合**
- 定期的に削除を試みる（上位ライブラリの更新で不要になる可能性）

**段階的なコミット**
- 各試行ごとにコミットして戻せるようにする
- コミットメッセージに試行した内容と結果を記載

## 重要な原則

- **yarn.lockの削除は行わない** - 破壊的で予期しない変更を引き起こす可能性がある
- **段階的に進める** - 一度に多くの変更をせず、各ステップで検証する
- **依存関係を理解する** - なぜそのバージョンが選ばれているかを常に確認する
- **resolutionsは最終手段** - できる限り自然な依存解決を優先する
